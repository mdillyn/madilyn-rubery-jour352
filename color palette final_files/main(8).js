define(function(require,exports,module){require("HTMLJumpToDef");const AppInit=brackets.getModule("utils/AppInit"),CodeHintManager=brackets.getModule("editor/CodeHintManager"),HTMLUtils=brackets.getModule("language/HTMLUtils"),PreferencesManager=brackets.getModule("preferences/PreferencesManager"),Strings=brackets.getModule("strings"),NewFileContentManager=brackets.getModule("features/NewFileContentManager"),CSSUtils=brackets.getModule("language/CSSUtils"),StringMatch=brackets.getModule("utils/StringMatch"),LiveDevelopment=brackets.getModule("LiveDevelopment/main"),KeyEvent=brackets.getModule("utils/KeyEvent"),Metrics=brackets.getModule("utils/Metrics"),HTMLTags=require("text!HtmlTags.json"),HTMLAttributes=require("text!HtmlAttributes.json"),HTMLTemplate=require("text!template.html"),XHTMLTemplate=require("text!template.xhtml");let tags,attributes;function TagHints(){this.exclusion=null}function AttrHints(){this.globalAttributes=this.readGlobalAttrHints(),this.cachedHints=null,this.exclusion=""}require("./html-lint"),PreferencesManager.definePreference("codehint.TagHints","boolean",!0,{description:Strings.DESCRIPTION_HTML_TAG_HINTS}),PreferencesManager.definePreference("codehint.AttrHints","boolean",!0,{description:Strings.DESCRIPTION_ATTR_HINTS}),TagHints.prototype.updateExclusion=function(){var textAfterCursor;this.exclusion&&this.tagInfo&&(textAfterCursor=this.tagInfo.tagName.substr(this.tagInfo.position.offset),CodeHintManager.hasValidExclusion(this.exclusion,textAfterCursor)||(this.exclusion=null))},TagHints.prototype.hasHints=function(editor,implicitChar){var pos=editor.getCursorPos();return this.tagInfo=HTMLUtils.getTagInfo(editor,pos),this.editor=editor,null===implicitChar?this.tagInfo.position.tokenType===HTMLUtils.TAG_NAME&&this.tagInfo.position.offset>=0&&(0===this.tagInfo.position.offset?this.exclusion=this.tagInfo.tagName:this.updateExclusion(),!0):"<"===implicitChar&&(this.exclusion=this.tagInfo.tagName,!0)},TagHints.prototype.getHints=function(implicitChar){var query,result;return this.tagInfo=HTMLUtils.getTagInfo(this.editor,this.editor.getCursorPos()),this.tagInfo.position.tokenType===HTMLUtils.TAG_NAME&&this.tagInfo.position.offset>=0?(this.updateExclusion(),query=this.tagInfo.tagName.slice(0,this.tagInfo.position.offset),{hints:result=$.map(tags,function(value,key){if(0===key.indexOf(query))return key}).sort(),match:query,selectInitial:!0,handleWideResults:!1}):null},TagHints.prototype.insertHint=function(completion){var start={line:-1,ch:-1},end={line:-1,ch:-1},cursor=this.editor.getCursorPos(),charCount=0;if(this.tagInfo.position.tokenType===HTMLUtils.TAG_NAME){var textAfterCursor=this.tagInfo.tagName.substr(this.tagInfo.position.offset);charCount=CodeHintManager.hasValidExclusion(this.exclusion,textAfterCursor)?this.tagInfo.position.offset:this.tagInfo.tagName.length}return end.line=start.line=cursor.line,start.ch=cursor.ch-this.tagInfo.position.offset,end.ch=start.ch+charCount,(this.exclusion||completion!==this.tagInfo.tagName)&&(start.ch!==end.ch?this.editor.document.replaceRange(completion,start,end):this.editor.document.replaceRange(completion,start),this.exclusion=null),!1},AttrHints.prototype.readGlobalAttrHints=function(){return $.map(attributes,function(value,key){if("true"===value.global)return key})};const MAX_CLASS_HINTS=250;function formatHints(hints){return StringMatch.basicMatchSort(hints),hints.length>MAX_CLASS_HINTS&&(hints=hints.splice(0,MAX_CLASS_HINTS)),hints.map(function(token){let $hintObj=$(`<span data-val='${token.label||token.value||token.text}'></span>`).addClass("brackets-html-hints brackets-hints");return token.stringRanges?token.stringRanges.forEach(function(item){item.matched?$hintObj.append($("<span>").text(item.text).addClass("matched-hint")):$hintObj.append(item.text)}):$hintObj.text(token.label),$hintObj.attr("data-val",token.label),$hintObj})}function _getAllClassHints(query){let queryStr=query.queryStr;const segments=queryStr.split(" ");queryStr=segments[segments.length-1];const deferred=$.Deferred();return CSSUtils.getAllCssSelectorsInProject({includeClasses:!0,scanCurrentHtml:!0}).then(hints=>{const result=$.map(hints,function(pvalue){return!(pvalue=pvalue.slice(1))||pvalue.includes("#")||pvalue.includes("\\")||pvalue.includes("/")?null:StringMatch.stringMatch(pvalue,queryStr,{preferPrefixMatches:!0})}),validHints=formatHints(result);validHints.alreadyMatched=!0,deferred.resolve(validHints)}).catch(console.error),deferred}AttrHints.prototype._getValueHintsForAttr=function(query,tagName,attrName){var hints=[];if("class"===attrName)return _getAllClassHints(query);var tagPlusAttr,attrInfo=attributes[tagName+"/"+attrName]||attributes[attrName];return attrInfo&&("boolean"===attrInfo.type?hints=["false","true"]:attrInfo.attribOption&&(hints=attrInfo.attribOption)),hints},AttrHints.prototype.updateExclusion=function(attrNameOnly){if(this.exclusion&&this.tagInfo){var tokenType=this.tagInfo.position.tokenType,offset=this.tagInfo.position.offset,textAfterCursor;tokenType===HTMLUtils.ATTR_NAME?textAfterCursor=this.tagInfo.attr.name.substr(offset):attrNameOnly||tokenType!==HTMLUtils.ATTR_VALUE||(textAfterCursor=this.tagInfo.attr.value.substr(offset)),CodeHintManager.hasValidExclusion(this.exclusion,textAfterCursor)||(this.exclusion=null)}};const HISTORY_PREFIX="Live_hint_CSS";let hintSessionId=0,isInLiveHighlightSession=!1;function NewDocContentProvider(){this.CONTENT_PROVIDER_NAME="HTMLCodeHints"}AttrHints.prototype.onClose=function(){isInLiveHighlightSession&&(this.editor.restoreHistoryPoint(`Live_hint_CSS${hintSessionId}`),isInLiveHighlightSession=!1),hintSessionId++},AttrHints.prototype.onHighlight=function($highlightedEl,_$descriptionElem,reason){if(!reason)return console.error("OnHighlight called without reason, should never happen!"),void hintSessionId++;const tokenType=this.tagInfo.position.tokenType,currentLivePreviewDetails=LiveDevelopment.getLivePreviewDetails();if(!currentLivePreviewDetails||!currentLivePreviewDetails.liveDocument||tokenType!==HTMLUtils.ATTR_VALUE||"class"!==this.tagInfo.attr.name)return;const currentlyEditedFile=this.editor.document.file.fullPath,livePreviewedFile=currentLivePreviewDetails.liveDocument.doc.file.fullPath;if(currentlyEditedFile!==livePreviewedFile)return;if(reason.source===CodeHintManager.SELECTION_REASON.SESSION_START)return hintSessionId++,void this.editor.createHistoryRestorePoint(`Live_hint_CSS${hintSessionId}`);if(reason.source!==CodeHintManager.SELECTION_REASON.KEYBOARD_NAV)return;const event=reason.event;if(event.keyCode!==KeyEvent.DOM_VK_UP&&event.keyCode!==KeyEvent.DOM_VK_DOWN&&event.keyCode!==KeyEvent.DOM_VK_PAGE_UP&&event.keyCode!==KeyEvent.DOM_VK_PAGE_DOWN)return;Metrics.countEvent(Metrics.EVENT_TYPE.LIVE_PREVIEW,"htmlClassHint","preview");const $hintItem=$highlightedEl.find(".brackets-html-hints"),highligtedValue=$highlightedEl.find(".brackets-html-hints").data("val");highligtedValue&&$hintItem.is(":visible")&&(isInLiveHighlightSession=!0,this.editor._dontDismissPopupOnScroll(),this.editor.restoreHistoryPoint(`Live_hint_CSS${hintSessionId}`),this.insertHint($highlightedEl.find(".brackets-html-hints"),!0))},AttrHints.prototype.hasHints=function(editor,implicitChar){var pos=editor.getCursorPos(),tokenType,offset,query;if(this.editor=editor,this.tagInfo=HTMLUtils.getTagInfo(editor,pos),tokenType=this.tagInfo.position.tokenType,offset=this.tagInfo.position.offset,null===implicitChar){if(query=null,tokenType===HTMLUtils.ATTR_NAME)offset>=0&&(query=this.tagInfo.attr.name.slice(0,offset));else if(tokenType===HTMLUtils.ATTR_VALUE){query=this.tagInfo.position.offset>=0?this.tagInfo.attr.value.slice(0,offset):"";const attrName=this.tagInfo.attr.name;if(attrName&&"class"!==attrName){let hints=this._getValueHintsForAttr({queryStr:query},this.tagInfo.tagName,attrName);if(hints instanceof Array){var i,foundPrefix=!1;for(i=0;i<hints.length;i++)if(0===hints[i].indexOf(query)){foundPrefix=!0;break}foundPrefix||(query=null)}}}return offset>=0&&(tokenType===HTMLUtils.ATTR_NAME&&0===offset?this.exclusion=this.tagInfo.attr.name:this.updateExclusion(!1)),null!==query}return(" "===implicitChar||"'"===implicitChar||'"'===implicitChar||"="===implicitChar)&&(tokenType===HTMLUtils.ATTR_NAME&&(this.exclusion=this.tagInfo.attr.name),!0)},AttrHints.prototype.getHints=function(implicitChar){var cursor=this.editor.getCursorPos(),query={queryStr:null},tokenType,offset,result=[];if(this.tagInfo=HTMLUtils.getTagInfo(this.editor,cursor),tokenType=this.tagInfo.position.tokenType,offset=this.tagInfo.position.offset,tokenType!==HTMLUtils.ATTR_NAME&&tokenType!==HTMLUtils.ATTR_VALUE||(query.tag=this.tagInfo.tagName,offset>=0?(tokenType===HTMLUtils.ATTR_NAME?query.queryStr=this.tagInfo.attr.name.slice(0,offset):(query.queryStr=this.tagInfo.attr.value.slice(0,offset),query.attrName=this.tagInfo.attr.name),this.updateExclusion(!1)):tokenType===HTMLUtils.ATTR_VALUE&&(query.queryStr="",query.attrName=this.tagInfo.attr.name),query.usedAttr=HTMLUtils.getTagAttributes(this.editor,cursor)),query.tag&&null!==query.queryStr){var tagName=query.tag,attrName=query.attrName,filter=query.queryStr,unfiltered=[],hints;if(attrName?hints=this._getValueHintsForAttr(query,tagName,attrName):tags&&tags[tagName]&&tags[tagName].attributes&&(unfiltered=tags[tagName].attributes.concat(this.globalAttributes),hints=$.grep(unfiltered,function(attr,i){return $.inArray(attr,query.usedAttr)<0})),hints instanceof Array&&hints.length)return console.assert(!result.length),{hints:result=$.map(hints,function(item){if(0===item.indexOf(filter))return item}).sort(),match:query.queryStr,selectInitial:!0,handleWideResults:!1};if(hints instanceof Object&&hints.hasOwnProperty("done")){var deferred=$.Deferred();return hints.done(function(asyncHints){deferred.resolveWith(this,[{hints:asyncHints,match:asyncHints.alreadyMatched?null:query.queryStr,selectInitial:!0,handleWideResults:!1}])}),deferred}return null}},AttrHints.prototype.insertHint=function(completion,isLiveHighlight){var cursor=this.editor.getCursorPos(),start={line:-1,ch:-1},end={line:-1,ch:-1},tokenType=this.tagInfo.position.tokenType,offset=this.tagInfo.position.offset,charCount=0,insertedName=!1,replaceExistingOne=this.tagInfo.attr.valueAssigned,endQuote="",shouldReplace=!0,positionWithinAttributeVal=!1,textAfterCursor;if(tokenType===HTMLUtils.ATTR_NAME)textAfterCursor=this.tagInfo.attr.name.substr(offset),CodeHintManager.hasValidExclusion(this.exclusion,textAfterCursor)?(charCount=offset,replaceExistingOne=!1):charCount=this.tagInfo.attr.name.length,!replaceExistingOne&&attributes&&attributes[completion]&&"flag"!==attributes[completion].type?(completion+='=""',insertedName=!0):completion===this.tagInfo.attr.name&&(shouldReplace=!1);else if(tokenType===HTMLUtils.ATTR_VALUE){if(textAfterCursor=this.tagInfo.attr.value.substr(offset),CodeHintManager.hasValidExclusion(this.exclusion,textAfterCursor)?(charCount=offset,this.exclusion=null):charCount=this.tagInfo.attr.value.length,"class"===this.tagInfo.attr.name){completion=completion.data("val");const textBeforeCursor=this.tagInfo.attr.value.slice(0,offset);let lastSegment=textBeforeCursor.split(" ");charCount=offset=(lastSegment=lastSegment[lastSegment.length-1]).length,positionWithinAttributeVal=!0}this.tagInfo.attr.hasEndQuote?completion===this.tagInfo.attr.value&&(shouldReplace=!1):(endQuote=this.tagInfo.attr.quoteChar)?completion+=endQuote:0===offset&&(completion='"'+completion+'"')}if(end.line=start.line=cursor.line,start.ch=cursor.ch-offset,end.ch=start.ch+charCount,isLiveHighlight){if(!this.editor.hasSelection()){const initialOffset=this.tagInfo.position.offset;let firstSegment=(textAfterCursor=this.tagInfo.attr.value.substr(initialOffset)).split(" ");firstSegment=firstSegment[0],end.ch=end.ch+firstSegment.length,this.editor.setSelection(start,end)}return this.editor.replaceSelection(completion,"around","liveHints"),!0}if(isInLiveHighlightSession&&(isInLiveHighlightSession=!1,hintSessionId++),this.editor.hasSelection())return this.editor.replaceSelection(completion,"end"),!0;if(shouldReplace&&(start.ch!==end.ch?this.editor.document.replaceRange(completion,start,end):this.editor.document.replaceRange(completion,start)),positionWithinAttributeVal)this.editor.setCursorPos(start.line,start.ch+completion.length);else{if(insertedName)return this.editor.setCursorPos(start.line,start.ch+completion.length-1),!0;tokenType===HTMLUtils.ATTR_VALUE&&this.tagInfo.attr.hasEndQuote&&this.editor.setCursorPos(start.line,start.ch+completion.length+1)}return!1},NewDocContentProvider.prototype.getContent=function(fileName){return new Promise((resolve,reject)=>{fileName.endsWith(".xhtml")?resolve(XHTMLTemplate):resolve(HTMLTemplate)})},AppInit.appReady(function(){tags=JSON.parse(HTMLTags),attributes=JSON.parse(HTMLAttributes);let tagHints=new TagHints,attrHints=new AttrHints,newDocContentProvider=new NewDocContentProvider;CodeHintManager.registerHintProvider(tagHints,["html"],0),CodeHintManager.registerHintProvider(attrHints,["html"],0),NewFileContentManager.registerContentProvider(newDocContentProvider,["html"],0),exports.tagHintProvider=tagHints,exports.attrHintProvider=attrHints})});
//# sourceMappingURL=main.js.map
